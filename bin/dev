#!/usr/bin/env ruby
# frozen_string_literal: true

require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = 'Usage: bin/dev [options] [command]'

  opts.on('-iIMAGE', '--image=IMAGE', 'Specify Docker image') do |val|
    options[:image] = val
  end
end.parse!

IMAGE = options.fetch(:image, 'ruby:latest')
NAME = "apm-agent-ruby:#{IMAGE.gsub(':', '_')}"

def run(cmd)
  system "IMAGE_NAME=#{NAME} #{cmd}"
end

run "docker-compose build --build-arg RUBY_IMAGE=#{IMAGE}"
run "docker-compose run --rm specs #{ARGV.join}"
